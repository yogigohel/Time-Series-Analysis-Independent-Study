Sub OrganizeSegmentDataOptimized()
    Dim srcSheet As Worksheet
    Dim tgtSheet As Worksheet
    Dim tbl As ListObject
    Dim valueArray As Variant
    Dim tgtRow As Long
    Dim i As Long
    Dim lastTicker As Long
    Dim startTime As Double
    
    ' Start timer to measure performance
    startTime = Timer
    
    ' Disable settings to improve performance
    With Application
        .ScreenUpdating = False
        .Calculation = xlCalculationManual
        .EnableEvents = False
        .DisplayStatusBar = False
    End With
    
    On Error GoTo Cleanup ' Ensure settings are restored even if an error occurs
    
    ' Initialize source sheet (active sheet)
    Set srcSheet = ActiveSheet
    
    ' Check if there's a table in the source sheet
    If srcSheet.ListObjects.Count = 0 Then
        MsgBox "No table found in the active sheet.", vbExclamation
        GoTo Cleanup
    End If
    
    ' Assume the first table in the sheet
    Set tbl = srcSheet.ListObjects(1)
    
    ' Read all values from the first column into an array
    valueArray = tbl.ListColumns(1).DataBodyRange.Value
    
    ' Create or clear the target sheet
    On Error Resume Next
    Set tgtSheet = Worksheets("SegmentData")
    If tgtSheet Is Nothing Then
        Set tgtSheet = Worksheets.Add(After:=Worksheets(Worksheets.Count))
        tgtSheet.Name = "SegmentData"
    Else
        tgtSheet.Cells.Clear
    End If
    On Error GoTo Cleanup
    
    ' Add a title at the top of the sheet
    With tgtSheet.Range("A1:C1")
        .Value = "Segment Data Overview"
        .Font.Size = 16
        .Font.Bold = True
        .Font.Color = RGB(0, 112, 192)
        .HorizontalAlignment = xlCenter
    End With
    ' Merge the title across columns A to C
    tgtSheet.Range("A1:C1").Merge
    
    ' Set column widths for better readability
    With tgtSheet
        .Columns("A").ColumnWidth = 20
        .Columns("B").ColumnWidth = 50
        .Columns("C").ColumnWidth = 30
    End With
    
    ' Initialize target row (start from row 3 to leave space below the title)
    tgtRow = 3
    
    ' Prepare arrays to hold data and formatting
    Dim headers() As Variant
    Dim labels() As Variant
    Dim formulasLabel() As Variant
    Dim formulasData() As Variant
    ReDim headers(1 To UBound(valueArray, 1), 1 To 1)
    ReDim labels(1 To UBound(valueArray, 1), 1 To 1)
    ReDim formulasLabel(1 To UBound(valueArray, 1), 1 To 1)
    ReDim formulasData(1 To UBound(valueArray, 1), 1 To 1)
    
    ' Populate arrays with data
    For i = 1 To UBound(valueArray, 1)
        headers(i, 1) = valueArray(i, 1)
        labels(i, 1) = "Segment Label:"
        formulasLabel(i, 1) = "=FDSR(A" & (tgtRow + (i - 1) * 4) & ",""FE_SEGMENT_LABEL(SALES,LABEL,BUS,+1,,Y,)"")"
        labels(i, 1) = "Segment Label:"
        formulasData(i, 1) = "=FDSR(A" & (tgtRow + (i - 1) * 4) & ",""FE_SEGMENT_DATA(SALES,LABEL,BUS,+1,,Y,)"")"
    Next i
    
    ' Write headers in bulk
    Dim headerRange As Range
    Set headerRange = tgtSheet.Range("A3:A" & (3 + UBound(headers, 1) * 4 - 1))
    
    ' Instead of writing headers one by one, we'll loop through and write each block
    For i = 1 To UBound(headers, 1)
        Dim currentRow As Long
        currentRow = tgtRow + (i - 1) * 4
        
        ' Write the header
        With tgtSheet.Cells(currentRow, 1)
            .Value = headers(i, 1)
            .Font.Size = 14
            .Font.Bold = True
            .Font.Color = RGB(0, 112, 192)
        End With
        
        ' Merge cells for the header across columns A to C
        tgtSheet.Range(tgtSheet.Cells(currentRow, 1), tgtSheet.Cells(currentRow, 3)).Merge
        tgtSheet.Range(tgtSheet.Cells(currentRow, 1), tgtSheet.Cells(currentRow, 3)).HorizontalAlignment = xlCenter
        
        ' Insert labels and formulas
        With tgtSheet.Cells(currentRow + 1, 1)
            .Value = "Segment Label:"
            .Font.Bold = True
        End With
        tgtSheet.Cells(currentRow + 1, 2).Formula = "=FDSR(A" & currentRow & ",""FE_SEGMENT_LABEL(SALES,LABEL,BUS,+1,,Y,)"")"
        
        With tgtSheet.Cells(currentRow + 2, 1)
            .Value = "Segment Data:"
            .Font.Bold = True
        End With
        tgtSheet.Cells(currentRow + 2, 2).Formula = "=FDSR(A" & currentRow & ",""FE_SEGMENT_DATA(SALES,LABEL,BUS,+1,,Y,)"")"
        
        ' Add borders around the data block
        With tgtSheet.Range(tgtSheet.Cells(currentRow, 1), tgtSheet.Cells(currentRow + 2, 3))
            .Borders.LineStyle = xlContinuous
            .Borders.Weight = xlThin
            .Borders.Color = RGB(200, 200, 200)
        End With
    Next i
    
    ' Autofit rows for better appearance
    tgtSheet.Rows.AutoFit
    
    ' Freeze panes to keep the title visible when scrolling
    tgtSheet.Activate
    tgtSheet.Range("A3").Select
    tgtSheet.Application.ActiveWindow.FreezePanes = True
    
    ' Apply a consistent font to the entire sheet
    With tgtSheet.Cells
        .Font.Name = "Calibri"
        .Font.Size = 11
    End With
    
    ' Restore settings
Cleanup:
    With Application
        .ScreenUpdating = True
        .Calculation = xlCalculationAutomatic
        .EnableEvents = True
        .DisplayStatusBar = True
    End With
    
    ' Calculate and display elapsed time
    Dim elapsedTime As Double
    elapsedTime = Timer - startTime
    MsgBox "Segment data has been successfully organized in the 'SegmentData' sheet." & vbCrLf & _
           "Elapsed Time: " & Format(elapsedTime, "0.00") & " seconds.", vbInformation
End Sub